<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora de Consumo de Combustível</title>
<!-- Tailwind CSS CDN -->
<script src="https://www.google.com/search?q=https://cdn.tailwindcss.com"></script>
<!-- Configuração da Fonte Inter -->
<style>
body {
font-family: 'Inter', sans-serif;
background-color: #f3f4f6;
}
</style>
<!-- Firebase SDKs -->
<script type="module">
import { initializeApp } from "https://www.google.com/search?q=https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.google.com/search?q=https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, limit, updateDoc, getDocs, setLogLevel, deleteDoc } from "https://www.google.com/search?q=https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Variáveis globais (fornecidas pelo ambiente Canvas/Immersive)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

    let db;
    let auth;
    let userId;

    // Função utilitária para conversão de Base64 para ArrayBuffer (necessária para Firebase)
    function base64ToArrayBuffer(base64) {
        const binary_string = window.atob(base64);
        const len = binary_string.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binary_string.charCodeAt(i);
        }
        return bytes.buffer;
    }

    // Funções de Inicialização e Autenticação
    window.initFirebase = async () => {
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Ativar logs de debug (opcional, mas útil para desenvolvimento)
            setLogLevel('error'); // Mantenha 'error' ou 'silent' para produção.

            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Usuário autenticado:", userId);
                    document.getElementById('user-id-display').textContent = `ID do Usuário: ${userId}`;
                    // Inicia o listener de dados após a autenticação
                    window.setupFirestoreListener();
                } else {
                    console.log("Nenhum usuário logado. O ID de usuário anônimo será usado.");
                    userId = crypto.randomUUID(); // Fallback para ID temporário
                    document.getElementById('user-id-display').textContent = `ID Temporário: ${userId}`;
                    // Não inicia o listener aqui, pois o token de auth pode ter expirado.
                    // O onAuthStateChanged deve garantir que a reautenticação ocorra.
                }
            });

        } catch (error) {
            console.error("Erro ao inicializar Firebase ou autenticar:", error);
            document.getElementById('status-message').textContent = "Erro de inicialização. Verifique o console.";
        }
    };

    // Função para obter o caminho da coleção de registros (privado do usuário)
    const getCollectionPath = () => {
        if (!userId) {
            console.error("UserID não definido. Não é possível acessar o Firestore.");
            return null;
        }
        // Caminho: /artifacts/{appId}/users/{userId}/fuel_logs
        return `artifacts/${appId}/users/${userId}/fuel_logs`;
    };

    // Função para calcular o consumo (km/L ou km/m³)
    const calculateConsumption = (currentOdometer, previousOdometer, fuelQuantity) => {
        if (!previousOdometer || !fuelQuantity || fuelQuantity === 0) return null;
        const distance = currentOdometer - previousOdometer;
        if (distance <= 0) return null;
        // Retorna km por unidade (L ou m³)
        return (distance / fuelQuantity).toFixed(2);
    };

    // Adicionar Log de Abastecimento
    window.addFuelLog = async (event) => {
        event.preventDefault();
        const path = getCollectionPath();
        if (!path) return;

        const form = event.target;
        const odometer = parseFloat(form.odometer.value);
        const fuelType = form.fuel_type.value;
        const quantity = parseFloat(form.quantity.value);
        const price = parseFloat(form.price.value);
        const date = form.date.value || new Date().toISOString().split('T')[0];

        if (isNaN(odometer) || isNaN(quantity) || isNaN(price) || odometer <= 0 || quantity <= 0 || price <= 0) {
            showModal('Atenção', 'Por favor, preencha todos os campos com valores válidos e positivos.');
            return;
        }

        try {
            const newLog = {
                odometer,
                fuel_type: fuelType,
                quantity,
                price_per_unit: price,
                date: new Date(date).toISOString(),
                timestamp: Date.now(),
                consumption: null, // O consumo será calculado no registro ANTERIOR
                km_per_unit: null, // O consumo será calculado no registro ANTERIOR
                distance_traveled: null // A autonomia será calculada no registro ANTERIOR
            };

            // 1. Buscar o registro anterior (apenas o último, ordenado pelo odômetro)
            const qPrevious = query(collection(db, path), orderBy("odometer", "desc"), limit(1));
            const previousDocs = await getDocs(qPrevious);
            const previousLog = previousDocs.docs.length > 0 ? { id: previousDocs.docs[0].id, ...previousDocs.docs[0].data() } : null;

            // 2. Adicionar o novo registro
            const docRef = await addDoc(collection(db, path), newLog);

            // 3. Se houver registro anterior, calcular o consumo e atualizar o registro ANTERIOR
            if (previousLog) {
                const consumption = calculateConsumption(newLog.odometer, previousLog.odometer, previousLog.quantity);
                const distance = newLog.odometer - previousLog.odometer;

                if (consumption) {
                    const unit = previousLog.fuel_type === 'Gasolina' ? 'km/L' : 'km/m³';

                    const updateData = {
                        consumption: `${consumption} ${unit}`,
                        km_per_unit: parseFloat(consumption),
                        distance_traveled: distance,
                        calculated_at_timestamp: Date.now()
                    };

                    // Atualiza o documento anterior (onde a autonomia e o consumo foram fechados)
                    const prevDocRef = doc(db, path, previousLog.id);
                    await updateDoc(prevDocRef, updateData);
                    console.log(`Consumo (${updateData.consumption}) e Autonomia (${updateData.distance_traveled} km) calculados e salvos no registro anterior: ${previousLog.id}`);
                }
            }

            showModal('Sucesso', `Registro de abastecimento (${fuelType} em ${odometer} km) adicionado com sucesso!`);
            form.reset();

        } catch (e) {
            console.error("Erro ao adicionar documento: ", e);
            showModal('Erro', 'Ocorreu um erro ao salvar o registro. Tente novamente.');
        }
    };

    // Função de Listener em Tempo Real (onSnapshot)
    window.setupFirestoreListener = () => {
        const path = getCollectionPath();
        if (!path) return;

        const logsCollectionRef = collection(db, path);
        // Ordena pelo odômetro (a ordem correta de abastecimento)
        const q = query(logsCollectionRef, orderBy("odometer", "desc"));

        onSnapshot(q, (snapshot) => {
            const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            window.renderLogs(logs);
            window.calculateAndDisplayAverages(logs);
        }, (error) => {
            console.error("Erro ao ouvir logs:", error);
            document.getElementById('status-message').textContent = "Erro ao carregar dados em tempo real.";
        });
    };

    // Funções de Renderização e Média
    window.renderLogs = (logs) => {
        const container = document.getElementById('fuel-logs-container');
        container.innerHTML = '';

        if (logs.length === 0) {
            container.innerHTML = '<p class="text-gray-500 italic p-4">Nenhum registro de abastecimento encontrado. Adicione o primeiro!</p>';
            return;
        }

        // Cabeçalho da tabela com 7 COLUNAS (incluindo Autonomia)
        const headerHtml = `
            <div class="grid grid-cols-7 gap-2 bg-gray-200 text-gray-700 font-semibold p-3 rounded-t-lg text-sm md:text-base">
                <div class="col-span-1">Data</div>
                <div class="col-span-1">Odômetro (km)</div>
                <div class="col-span-1">Combustível</div>
                <div class="col-span-1">Qtd (L/m³)</div>
                <div class="col-span-1 text-center">Autonomia (km)</div>
                <div class="col-span-1 text-center">Consumo</div>
                <div class="col-span-1 text-center">Ações</div>
            </div>
        `;
        container.innerHTML += headerHtml;

        logs.forEach(log => {
            const dateOnly = log.date ? new Date(log.date).toLocaleDateString('pt-BR') : 'N/A';
            
            // Display para Consumo
            const consumptionDisplay = log.consumption || (log.id === logs[logs.length - 1].id ? 'Primeiro Reg. / Pendente' : 'Pendente');
            
            // Display para Autonomia (distance_traveled)
            const autonomyDisplay = log.distance_traveled ? log.distance_traveled.toFixed(0).toLocaleString('pt-BR') : '...';
            
            const autonomyClass = log.distance_traveled ? 'text-gray-800 font-medium' : 'text-gray-500 italic';


            // Linha da tabela com 7 COLUNAS
            const rowHtml = `
                <div class="grid grid-cols-7 gap-2 border-b border-gray-200 hover:bg-gray-50 p-3 text-sm md:text-base items-center">
                    <div class="col-span-1 text-gray-600">${dateOnly}</div>
                    <div class="col-span-1 font-medium text-blue-700">${log.odometer.toLocaleString('pt-BR')}</div>
                    <div class="col-span-1">${log.fuel_type}</div>
                    <div class="col-span-1">${log.quantity.toFixed(2).replace('.', ',')}</div>
                    
                    <!-- Autonomy/Distance Traveled -->
                    <div class="col-span-1 text-center ${autonomyClass}">
                        ${autonomyDisplay}
                    </div>
                    
                    <div class="col-span-1 text-center font-bold ${log.consumption ? 'text-green-600' : 'text-yellow-600'}">
                        ${consumptionDisplay}
                    </div>
                    <div class="col-span-1 flex justify-center">
                        <button onclick="window.deleteLog('${log.id}')" class="text-red-500 hover:text-red-700 p-1 rounded transition duration-150" title="Excluir Registro">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            container.innerHTML += rowHtml;
        });
    };

    window.calculateAndDisplayAverages = (logs) => {
        let totalKmPerL = 0;
        let countKmPerL = 0;
        let totalKmPerM3 = 0;
        let countKmPerM3 = 0;

        logs.forEach(log => {
            if (log.km_per_unit) {
                if (log.fuel_type === 'Gasolina') {
                    totalKmPerL += log.km_per_unit;
                    countKmPerL++;
                } else if (log.fuel_type === 'GNV') {
                    totalKmPerM3 += log.km_per_unit;
                    countKmPerM3++;
                }
            }
        });

        const avgKmPerL = countKmPerL > 0 ? (totalKmPerL / countKmPerL).toFixed(2) : 'N/A';
        const avgKmPerM3 = countKmPerM3 > 0 ? (totalKmPerM3 / countKmPerM3).toFixed(2) : 'N/A';

        document.getElementById('avg-gasolina').textContent = `${avgKmPerL} km/L`;
        document.getElementById('avg-gnv').textContent = `${avgKmPerM3} km/m³`;
    };

    // Função para deletar log
    window.deleteLog = async (logId) => {
        const path = getCollectionPath();
        if (!path) return;

        // Substitua esta chamada de função por um modal personalizado para evitar alert()
        const confirmDelete = await showConfirmModal('Confirmação', 'Tem certeza de que deseja excluir este registro? Esta ação é irreversível.');

        if (!confirmDelete) return;

        try {
            // Ao deletar um log, precisamos recalcular os logs adjacentes para corrigir a sequência.
            // Isso pode ser complexo. Por enquanto, faremos a exclusão simples e notificamos.
            
            await deleteDoc(doc(db, path, logId));
            showModal('Sucesso', 'Registro excluído com sucesso.');
            // O onSnapshot garantirá a atualização da UI.

        } catch (e) {
            console.error("Erro ao deletar documento: ", e);
            showModal('Erro', 'Ocorreu um erro ao excluir o registro.');
        }
    };

    // --- Funções de Modal (Substituição de alert/confirm) ---
    function showModal(title, message) {
        const modalTitle = document.getElementById('custom-modal-title');
        const modalMessage = document.getElementById('custom-modal-message');
        const modal = document.getElementById('custom-modal');

        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modal.classList.remove('hidden');

        // Configura o botão de fechar para fechar o modal
        document.getElementById('custom-modal-close').onclick = () => modal.classList.add('hidden');
    }

    function showConfirmModal(title, message) {
        return new Promise((resolve) => {
            const modalTitle = document.getElementById('confirm-modal-title');
            const modalMessage = document.getElementById('confirm-modal-message');
            const modal = document.getElementById('confirm-modal');
            const btnConfirm = document.getElementById('confirm-modal-confirm');
            const btnCancel = document.getElementById('confirm-modal-cancel');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');

            const closeModal = () => modal.classList.add('hidden');

            btnConfirm.onclick = () => {
                closeModal();
                resolve(true);
            };
            btnCancel.onclick = () => {
                closeModal();
                resolve(false);
            };
        });
    }

    // Inicializa o Firebase no carregamento da página
    window.onload = window.initFirebase;

</script>


</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">

<div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-2">⛽ Calculadora de Consumo</h1>
    <p id="user-id-display" class="text-sm text-gray-500 mb-4"></p>
    <p id="status-message" class="text-sm text-red-500 mb-4"></p>

    <!-- Seção de Médias de Consumo -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Média de Consumo Calculada</h2>
        <div class="flex flex-col sm:flex-row gap-4">
            <div class="flex-1 bg-blue-50 p-4 rounded-lg border-2 border-blue-200">
                <p class="text-sm font-medium text-blue-600">Gasolina</p>
                <p id="avg-gasolina" class="text-2xl font-bold text-blue-800">...</p>
                <p class="text-xs text-blue-500">Km por Litro (km/L)</p>
            </div>
            <div class="flex-1 bg-green-50 p-4 rounded-lg border-2 border-green-200">
                <p class="text-sm font-medium text-green-600">GNV</p>
                <p id="avg-gnv" class="text-2xl font-bold text-green-800">...</p>
                <p class="text-xs text-green-500">Km por Metro Cúbico (km/m³)</p>
            </div>
        </div>
    </div>

    <!-- Formulário de Abastecimento -->
    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Adicionar Novo Abastecimento</h2>
        <form id="fuel-log-form" onsubmit="window.addFuelLog(event)" class="space-y-4">

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Odômetro -->
                <div class="col-span-1">
                    <label for="odometer" class="block text-sm font-medium text-gray-700">Odômetro (km)</label>
                    <input type="number" step="0.1" id="odometer" name="odometer" placeholder="Ex: 125000" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <!-- Tipo de Combustível -->
                <div class="col-span-1">
                    <label for="fuel_type" class="block text-sm font-medium text-gray-700">Combustível</label>
                    <select id="fuel_type" name="fuel_type" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                        <option value="Gasolina">Gasolina/Etanol</option>
                        <option value="GNV">GNV</option>
                    </select>
                </div>

                <!-- Quantidade -->
                <div class="col-span-1">
                    <label for="quantity" class="block text-sm font-medium text-gray-700">Quantidade (L/m³)</label>
                    <input type="number" step="0.01" id="quantity" name="quantity" placeholder="Ex: 45.50" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>

                <!-- Preço por Unidade -->
                <div class="col-span-1">
                    <label for="price" class="block text-sm font-medium text-gray-700">Preço por Unidade (R$)</label>
                    <input type="number" step="0.01" id="price" name="price" placeholder="Ex: 5.99" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
                </div>
            </div>

            <!-- Data do Abastecimento -->
            <div class="col-span-4">
                <label for="date" class="block text-sm font-medium text-gray-700">Data do Abastecimento</label>
                <input type="date" id="date" name="date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:border-indigo-500 focus:ring-indigo-500">
            </div>

            <div class="pt-4">
                <button type="submit"
                        class="w-full md:w-auto px-6 py-2 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                    Registrar Abastecimento
                </button>
            </div>
        </form>
    </div>

    <!-- Tabela de Logs de Abastecimento -->
    <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Histórico de Registros</h2>
        <div id="fuel-logs-container" class="space-y-2 min-w-full">
            <!-- Logs serão renderizados aqui pelo JavaScript -->
            <p class="text-gray-500 italic p-4">Carregando registros...</p>
        </div>
    </div>

</div>

<!-- Custom Modal (Substituição de alert()) -->
<div id="custom-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-2xl transform scale-100">
        <h3 id="custom-modal-title" class="text-xl font-bold text-gray-900 mb-3">Título</h3>
        <p id="custom-modal-message" class="text-gray-700 mb-6">Mensagem</p>
        <div class="flex justify-end">
            <button id="custom-modal-close" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-150">
                OK
            </button>
        </div>
    </div>
</div>

<!-- Custom Confirm Modal (Substituição de confirm()) -->
<div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-2xl transform scale-100">
        <h3 id="confirm-modal-title" class="text-xl font-bold text-gray-900 mb-3">Confirmação</h3>
        <p id="confirm-modal-message" class="text-gray-700 mb-6">Você tem certeza?</p>
        <div class="flex justify-end space-x-3">
            <button id="confirm-modal-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition duration-150">
                Cancelar
            </button>
            <button id="confirm-modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-150">
                Confirmar
            </button>
        </div>
    </div>
</div>
